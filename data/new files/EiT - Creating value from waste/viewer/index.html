<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SRM Company Assessment Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/lokijs@1.5.12/build/lokijs.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f7fa;
      color: #1a1a2e;
      min-height: 100vh;
    }

    header {
      background: #1a1a2e;
      color: #fff;
      padding: 18px 28px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header h1 { font-size: 1.25rem; font-weight: 600; }
    header span { font-size: 0.85rem; opacity: 0.55; }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 24px;
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
      flex-wrap: wrap;
    }
    .toolbar input[type="search"] {
      flex: 1;
      min-width: 200px;
      padding: 7px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 0.9rem;
      outline: none;
    }
    .toolbar input[type="search"]:focus { border-color: #6366f1; }
    .toolbar select {
      padding: 7px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 0.9rem;
      background: #fff;
      cursor: pointer;
    }
    .toolbar .count {
      margin-left: auto;
      font-size: 0.8rem;
      color: #64748b;
      white-space: nowrap;
    }

    .table-wrap {
      padding: 20px 24px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      font-size: 0.875rem;
    }

    thead th {
      background: #1a1a2e;
      color: #e2e8f0;
      padding: 11px 14px;
      text-align: left;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    thead th:hover { background: #2d2d54; }
    thead th .sort-arrow { margin-left: 5px; opacity: 0.45; font-size: 0.75rem; }
    thead th.active .sort-arrow { opacity: 1; }

    tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #f8faff; }

    td { padding: 10px 14px; vertical-align: top; }

    .company-name { font-weight: 600; color: #1a1a2e; }
    .legal-name { font-size: 0.78rem; color: #64748b; margin-top: 2px; }
    .org { font-size: 0.78rem; color: #94a3b8; font-family: monospace; }

    .nace-list { display: flex; flex-wrap: wrap; gap: 4px; }
    .nace-chip {
      background: #e0e7ff;
      color: #3730a3;
      padding: 2px 7px;
      border-radius: 12px;
      font-size: 0.73rem;
      font-family: monospace;
    }

    .tier {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    .tier-T0 { background: #f1f5f9; color: #64748b; }
    .tier-T1 { background: #fef9c3; color: #92400e; }
    .tier-T2 { background: #dbeafe; color: #1d4ed8; }
    .tier-T3 { background: #dcfce7; color: #166534; }

    .srm-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px; height: 24px;
      border-radius: 50%;
      background: #e0e7ff;
      color: #3730a3;
      font-size: 0.78rem;
      font-weight: 700;
    }
    .srm-count.zero { background: #f1f5f9; color: #94a3b8; }

    .num { font-variant-numeric: tabular-nums; text-align: right; }

    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: #94a3b8;
    }
    .empty-state h2 { font-size: 1.1rem; margin-bottom: 8px; }

    .error-banner {
      margin: 24px;
      padding: 16px 20px;
      background: #fee2e2;
      border: 1px solid #fca5a5;
      border-radius: 8px;
      color: #991b1b;
      font-size: 0.9rem;
    }

    /* Detail modal */
    .detail-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -44%) scale(0.97);
      width: min(760px, 92vw);
      max-height: 85vh;
      background: #fff;
      box-shadow: 0 8px 48px rgba(0,0,0,0.22);
      border-radius: 14px;
      overflow-y: auto;
      z-index: 100;
      padding: 28px 32px 32px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .detail-panel.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    .detail-close {
      position: absolute;
      top: 14px; right: 16px;
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: #64748b;
    }
    .detail-company { font-size: 1.1rem; font-weight: 700; margin: 8px 0 4px; }
    .detail-legal { color: #64748b; font-size: 0.85rem; margin-bottom: 16px; }
    .detail-section { margin-top: 20px; }
    .detail-section h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .summary-text { font-size: 0.875rem; line-height: 1.6; color: #374151; }
    .srm-card {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 0.85rem;
    }
    .srm-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .srm-card-label { font-weight: 600; }
    .srm-card-body { color: #4b5563; line-height: 1.5; }
    .mece-chip {
      background: #f1f5f9;
      color: #475569;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.72rem;
      font-family: monospace;
    }

    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 99;
    }
    .overlay.show { display: block; }

    /* Stats section */
    .stats-section {
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
      padding: 16px 24px;
    }
    .stats-title {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #94a3b8;
      margin-bottom: 12px;
    }
    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .stat-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1.5px solid #e2e8f0;
      background: #f8fafc;
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.12s;
      user-select: none;
      white-space: nowrap;
    }
    .stat-chip:hover { border-color: #6366f1; background: #eef2ff; }
    .stat-chip.active { border-color: #6366f1; background: #e0e7ff; color: #3730a3; font-weight: 600; }
    .stat-chip .code {
      font-family: monospace;
      font-size: 0.72rem;
      background: #e0e7ff;
      color: #3730a3;
      padding: 1px 5px;
      border-radius: 4px;
    }
    .stat-chip.active .code { background: #c7d2fe; }
    .stat-chip .badge {
      background: #1a1a2e;
      color: #fff;
      border-radius: 10px;
      padding: 1px 6px;
      font-size: 0.7rem;
      font-weight: 700;
      min-width: 18px;
      text-align: center;
    }
    .stat-chip.active .badge { background: #4338ca; }
    .stat-chip.zero { opacity: 0.45; cursor: default; }
    .stat-chip.zero:hover { border-color: #e2e8f0; background: #f8fafc; }

    /* Inline citation links */
    .cite-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.68rem;
      font-weight: 700;
      padding: 0 4px;
      min-width: 16px;
      height: 16px;
      border-radius: 3px;
      background: #e0e7ff;
      color: #3730a3;
      text-decoration: none;
      vertical-align: middle;
      margin: 0 1px;
      line-height: 1;
    }
    .cite-link:hover { background: #c7d2fe; text-decoration: underline; }

    /* Evidence items */
    .evidence-list { margin-top: 10px; display: flex; flex-direction: column; gap: 7px; }
    .evidence-item {
      border-left: 3px solid #c7d2fe;
      padding: 6px 10px;
      background: #f8fafc;
      border-radius: 0 6px 6px 0;
      font-size: 0.8rem;
    }
    .evidence-snippet {
      display: block;
      font-style: italic;
      color: #1e3a5f;
      background: #e0e7ff;
      border-radius: 4px;
      padding: 3px 7px;
      text-decoration: none;
      margin-bottom: 4px;
      line-height: 1.5;
      transition: background 0.12s;
    }
    .evidence-snippet:hover { background: #c7d2fe; text-decoration: underline; }
    .evidence-snippet::before { content: '\201C'; margin-right: 1px; }
    .evidence-snippet::after  { content: '\201D'; margin-left: 1px; }
    .evidence-claim { color: #374151; line-height: 1.4; }
    .evidence-hint  { font-size: 0.72rem; color: #94a3b8; margin-top: 2px; }

    /* Quantity display */
    .quantity-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0 4px;
    }
    .quantity-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 0.78rem;
      font-weight: 600;
    }
    .quantity-pill.share {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #1e3a8a;
    }
    .quantity-pill .q-label {
      font-weight: 400;
      font-size: 0.72rem;
      opacity: 0.7;
      margin-left: 2px;
    }

    /* Sources list */
    .source-list { display: flex; flex-direction: column; gap: 6px; }
    .source-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.8rem;
      padding: 7px 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 7px;
    }
    .source-num {
      min-width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #1a1a2e;
      color: #fff;
      font-size: 0.68rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .source-type {
      display: inline-block;
      font-size: 0.68rem;
      padding: 1px 6px;
      border-radius: 10px;
      background: #e0e7ff;
      color: #3730a3;
      font-family: monospace;
      white-space: nowrap;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .source-body { flex: 1; min-width: 0; }
    .source-title { font-weight: 600; color: #1a1a2e; }
    .source-title a { color: #2563eb; text-decoration: none; }
    .source-title a:hover { text-decoration: underline; }
    .source-meta { color: #94a3b8; font-size: 0.72rem; margin-top: 2px; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>SRM Assessment Viewer</h1>
    <span id="meta-info">Loading…</span>
  </div>
</header>

<div class="stats-section">
  <div class="stats-title">Companies using each SRM category — click to filter</div>
  <div class="stats-grid" id="stats-grid"></div>
</div>

<div class="toolbar">
  <input type="search" id="search" placeholder="Search by name, org number, NACE…" />
  <select id="tier-filter">
    <option value="">All tiers</option>
    <option value="T0">T0 – No evidence</option>
    <option value="T1">T1 – Minor / Pilot</option>
    <option value="T2">T2 – Meaningful</option>
    <option value="T3">T3 – Significant</option>
  </select>
  <span class="count" id="row-count"></span>
</div>

<div id="error-container"></div>

<div class="table-wrap">
  <table id="main-table">
    <thead>
      <tr>
        <th data-col="input_name">Company <span class="sort-arrow">↕</span></th>
        <th data-col="org_number">Org № <span class="sort-arrow">↕</span></th>
        <th data-col="nace_codes">NACE <span class="sort-arrow">↕</span></th>
        <th data-col="employees" class="num">Employees <span class="sort-arrow">↕</span></th>
        <th data-col="revenue" class="num">Revenue (MNOK) <span class="sort-arrow">↕</span></th>
        <th data-col="overall_tier">Tier <span class="sort-arrow">↕</span></th>
        <th data-col="srm_count">SRM Inputs <span class="sort-arrow">↕</span></th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
  <div id="empty-state" class="empty-state" style="display:none">
    <h2>No companies match</h2>
    <p>Try clearing the search or filter.</p>
  </div>
</div>

<!-- Detail side panel -->
<div class="overlay" id="overlay"></div>
<div class="detail-panel" id="detail-panel">
  <button class="detail-close" id="detail-close" title="Close">✕</button>
  <div id="detail-content"></div>
</div>

<script>
(async () => {
  // ---------- SRM Taxonomy ----------
  const SRM_CATEGORIES = {
    A1:  { group: "A", name: "Mineral & Construction Materials",    desc: "Recycled aggregates, crushed concrete, reclaimed asphalt pavement (RAP), excavation fill" },
    A2:  { group: "A", name: "Industrial Mineral By-Products",      desc: "Slag, fly ash, bottom ash, silica fume, gypsum from flue-gas desulfurisation" },
    A3:  { group: "A", name: "Metals – Ferrous & Non-Ferrous Scrap",desc: "Steel scrap, aluminium scrap, copper scrap, cast-iron scrap fed to smelters/foundries" },
    A4:  { group: "A", name: "Plastics – Reprocessed Polymers",     desc: "Recycled polymer pellets, regranulate, post-consumer or post-industrial plastic waste" },
    A5:  { group: "A", name: "Glass & Ceramics",                    desc: "Cullet (recycled glass), recycled ceramic or refractory material" },
    A6:  { group: "A", name: "Paper & Cardboard Fibres",            desc: "Recovered paper, recycled pulp, cardboard fibre used in paper or packaging production" },
    A7:  { group: "A", name: "Textiles & Fibres",                   desc: "Recovered textile fibres, recycled yarn, post-consumer fabric used as input" },
    A8:  { group: "A", name: "Rubber & Tyres",                      desc: "Ground rubber, crumb rubber from end-of-life tyres, devulcanised rubber" },
    A9:  { group: "A", name: "Bio-Based Material Residues (non-energy)", desc: "Wood chips, sawdust, straw, digestate, organic residues used as material input" },
    A10: { group: "A", name: "Chemical & Liquid Feedstocks",        desc: "Recovered solvents, recycled oils, chemical by-products reused as process feedstock" },
    B1:  { group: "B", name: "Solid Recovered Fuel (SRF / RDF)",    desc: "Refuse-derived fuel or solid recovered fuel co-fired or used in kilns/boilers" },
    B2:  { group: "B", name: "Biomass Fuels",                       desc: "Wood pellets, wood chips, bio-oil, recovered biomass used as energy input" },
    B3:  { group: "B", name: "Biogas",                              desc: "Biogas or biomethane used as fuel or process energy (transport, heating, power)" },
  };

  // ---------- Load data ----------
  let raw;
  try {
    const resp = await fetch("./aggregated.json");
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    raw = await resp.json();
  } catch (e) {
    document.getElementById("error-container").innerHTML =
      `<div class="error-banner">
        <strong>Could not load aggregated.json</strong><br>
        ${e.message}<br><br>
        Make sure you have run <code>python cli.py aggregate</code> and are serving this file via a local web server
        (e.g. <code>python -m http.server</code> from the project root).
      </div>`;
    document.getElementById("meta-info").textContent = "Failed to load";
    return;
  }

  const generated = raw.generated_at ? new Date(raw.generated_at).toLocaleString() : "unknown";
  document.getElementById("meta-info").textContent =
    `${raw.total} companies · generated ${generated}`;

  // ---------- LokiJS setup ----------
  const db = new loki("srm.db");
  const coll = db.addCollection("companies");

  for (const entry of raw.companies) {
    const c = entry.company || {};
    const s = entry.srm_assessment || {};
    const inputs = s.srm_inputs || [];
    coll.insert({
      input_name:    c.input_name   || "",
      canonical_name: c.canonical_name || "",
      legal_name:    c.legal_name   || "",
      org_number:    c.org_number   || "",
      nace_codes:    (c.nace_codes  || []).join(", "),
      employees:     c.employees?.value ?? null,
      revenue:       c.revenue?.value   ?? null,
      overall_tier:  s.overall_tier     || "T0",
      srm_count:     inputs.length,
      srm_codes:     [...new Set(inputs.map(i => i.mece_category_code).filter(Boolean))],
      _raw: entry,
    });
  }

  // ---------- Stats ----------
  function renderStats() {
    const all = coll.find();
    const grid = document.getElementById("stats-grid");
    grid.innerHTML = Object.entries(SRM_CATEGORIES).map(([code, cat]) => {
      const count = all.filter(r => r.srm_codes.includes(code)).length;
      const active = filterSrm === code ? " active" : "";
      const zero   = count === 0 && !active ? " zero" : "";
      return `<div class="stat-chip${active}${zero}" data-code="${code}" title="${esc(cat.desc)}">
        <span class="code">${code}</span>
        <span>${esc(cat.name)}</span>
        <span class="badge">${count}</span>
      </div>`;
    }).join("");
    grid.querySelectorAll(".stat-chip:not(.zero)").forEach(chip => {
      chip.addEventListener("click", () => {
        filterSrm = filterSrm === chip.dataset.code ? "" : chip.dataset.code;
        renderStats();
        renderTable();
      });
    });
  }

  // ---------- State ----------
  let sortCol = "input_name";
  let sortDir = 1; // 1 asc, -1 desc
  let filterText = "";
  let filterTier = "";
  let filterSrm  = "";

  // ---------- Render ----------
  function applyFiltersAndSort() {
    let rows = coll.find();

    if (filterText) {
      const q = filterText.toLowerCase();
      rows = rows.filter(r =>
        r.input_name.toLowerCase().includes(q) ||
        r.legal_name.toLowerCase().includes(q) ||
        r.org_number.includes(q) ||
        r.nace_codes.toLowerCase().includes(q)
      );
    }

    if (filterTier) {
      rows = rows.filter(r => r.overall_tier === filterTier);
    }

    if (filterSrm) {
      rows = rows.filter(r => r.srm_codes.includes(filterSrm));
    }

    rows.sort((a, b) => {
      let av = a[sortCol], bv = b[sortCol];
      if (av === null || av === undefined) av = sortDir === 1 ? Infinity : -Infinity;
      if (bv === null || bv === undefined) bv = sortDir === 1 ? Infinity : -Infinity;
      if (typeof av === "string") av = av.toLowerCase();
      if (typeof bv === "string") bv = bv.toLowerCase();
      return av < bv ? -sortDir : av > bv ? sortDir : 0;
    });

    return rows;
  }

  function fmtNum(v, divisor = 1, decimals = 0) {
    if (v === null || v === undefined) return "—";
    return (v / divisor).toLocaleString("en-NO", {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals,
    });
  }

  function renderTable() {
    const rows = applyFiltersAndSort();
    const tbody = document.getElementById("table-body");
    const empty = document.getElementById("empty-state");

    if (rows.length === 0) {
      tbody.innerHTML = "";
      empty.style.display = "";
      document.getElementById("row-count").textContent = "0 results";
      return;
    }

    empty.style.display = "none";
    document.getElementById("row-count").textContent =
      `${rows.length} / ${coll.count()} companies`;

    tbody.innerHTML = rows.map(r => `
      <tr data-id="${r.$loki}" style="cursor:pointer">
        <td>
          <div class="company-name">${esc(r.input_name)}</div>
          ${r.legal_name && r.legal_name !== r.input_name
            ? `<div class="legal-name">${esc(r.legal_name)}</div>` : ""}
          ${r.org_number ? `<div class="org">${esc(r.org_number)}</div>` : ""}
        </td>
        <td><span class="org">${esc(r.org_number) || "—"}</span></td>
        <td>
          <div class="nace-list">
            ${r.nace_codes ? r.nace_codes.split(", ").map(n =>
              `<span class="nace-chip">${esc(n)}</span>`).join("") : "—"}
          </div>
        </td>
        <td class="num">${fmtNum(r.employees)}</td>
        <td class="num">${fmtNum(r.revenue, 1_000_000, 1)}</td>
        <td><span class="tier tier-${esc(r.overall_tier)}">${esc(r.overall_tier)}</span></td>
        <td style="text-align:center">
          <span class="srm-count ${r.srm_count === 0 ? 'zero' : ''}">${r.srm_count}</span>
        </td>
      </tr>
    `).join("");

    // Row click → detail panel
    tbody.querySelectorAll("tr[data-id]").forEach(tr => {
      tr.addEventListener("click", () => {
        const id = parseInt(tr.dataset.id, 10);
        const rec = coll.get(id);
        if (rec) openDetail(rec);
      });
    });
  }

  function esc(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  // Replace [N] bracket citations with linked superscript badges.
  // srcMap: { [source_id]: { url, title } }
  function cite(text, srcMap) {
    return esc(text).replace(/\[(\d+)\]/g, (_, n) => {
      const src = srcMap[Number(n)];
      if (!src) return `[${n}]`;
      const label = esc(src.title ? `${src.title}` : src.url);
      return `<a class="cite-link" href="${esc(src.url)}" target="_blank" rel="noopener" title="[${n}] ${label}">${n}</a>`;
    });
  }

  // ---------- Sort headers ----------
  document.querySelectorAll("thead th[data-col]").forEach(th => {
    th.addEventListener("click", () => {
      const col = th.dataset.col;
      if (sortCol === col) {
        sortDir *= -1;
      } else {
        sortCol = col;
        sortDir = 1;
      }
      document.querySelectorAll("thead th").forEach(t => t.classList.remove("active"));
      th.classList.add("active");
      th.querySelector(".sort-arrow").textContent = sortDir === 1 ? "↑" : "↓";
      renderTable();
    });
  });

  // ---------- Search & filter ----------
  document.getElementById("search").addEventListener("input", e => {
    filterText = e.target.value.trim();
    renderTable();
  });
  document.getElementById("tier-filter").addEventListener("change", e => {
    filterTier = e.target.value;
    renderTable();
  });

  // ---------- Detail panel ----------
  function openDetail(rec) {
    const raw = rec._raw;
    const c = raw.company || {};
    const s = raw.srm_assessment || {};
    const inputs = s.srm_inputs || [];

    // Build source id → {url, title} map for citation linking
    const srcMap = {};
    for (const src of (raw.sources || [])) {
      srcMap[src.source_id] = { url: src.url, title: src.title };
    }

    // Build evidence_id → evidence item map
    const evidenceMap = {};
    for (const ev of (raw.evidence || [])) {
      evidenceMap[ev.evidence_id] = ev;
    }

    function fmtQuantity(q) {
      if (!q) return null;
      const val = q.value != null ? q.value.toLocaleString("en-NO") : "?";
      const unit = q.unit || "";
      const year = q.year ? ` (${q.year})` : "";
      const period = q.period && q.period !== "unknown" ? ` / ${q.period.replace("per_", "")}` : "";
      const basis = q.basis ? ` · ${q.basis.replace(/_/g, " ")}` : "";
      const conf = q.confidence ? ` · ${q.confidence} confidence` : "";
      return `${val} ${unit}${period}${year}${basis}${conf}`;
    }

    function renderEvidence(ids) {
      if (!ids || ids.length === 0) return "";
      const items = ids.map(id => evidenceMap[id]).filter(Boolean);
      if (items.length === 0) return "";
      return `<div class="evidence-list">${items.map(ev => {
        const src = srcMap[ev.source_id];
        const baseUrl = src?.url ?? null;
        const words = ev.evidence_snippet.trim().replace(/-/g, "%2D").split(/\s+/);
        const textParam = words.length > 6
          ? encodeURIComponent(words.slice(0, 3).join(" ")) + "," + encodeURIComponent(words.slice(-3).join(" "))
          : encodeURIComponent(ev.evidence_snippet);
        const fragment = "#:~:text=" + textParam;
        const url = baseUrl ? baseUrl + fragment : null;
        const snippetEl = url
          ? `<a class="evidence-snippet" href="${esc(url)}" target="_blank" rel="noopener">${esc(ev.evidence_snippet)}</a>`
          : `<span class="evidence-snippet" style="cursor:default">${esc(ev.evidence_snippet)}</span>`;
        return `<div class="evidence-item">
          ${snippetEl}
          <div class="evidence-claim">${esc(ev.claim)}</div>
          ${ev.location_hint ? `<div class="evidence-hint">${esc(ev.location_hint)}</div>` : ""}
        </div>`;
      }).join("")}</div>`;
    }

    const srmCards = inputs.map(inp => `
      <div class="srm-card">
        <div class="srm-card-header">
          <span class="mece-chip" title="${esc(SRM_CATEGORIES[inp.mece_category_code]?.desc ?? '')}">${esc(inp.mece_category_code)}</span>
          <span class="tier tier-${esc(inp.tier)}">${esc(inp.tier)}</span>
          <span class="srm-card-label">${esc(inp.label)}</span>
        </div>
        <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:6px">${esc(SRM_CATEGORIES[inp.mece_category_code]?.name ?? '')}</div>
        <div class="srm-card-body">
          ${inp.material_examples?.length
            ? `<strong>Examples:</strong> ${esc(inp.material_examples.join(", "))}<br>` : ""}
          ${inp.used_for ? `<strong>Used for:</strong> ${cite(inp.used_for, srcMap)}<br>` : ""}
          ${inp.tier_reasoning ? `<em>${cite(inp.tier_reasoning, srcMap)}</em>` : ""}
        </div>
        ${(() => {
          const pills = [];
          const mq = fmtQuantity(inp.main_quantity);
          if (mq) pills.push(`<span class="quantity-pill">${esc(mq)}<span class="q-label">main qty</span></span>`);
          if (inp.other_quantities?.length) {
            inp.other_quantities.forEach((oq, i) => {
              const s = fmtQuantity(oq);
              if (s) pills.push(`<span class="quantity-pill">${esc(s)}<span class="q-label">qty ${i+2}</span></span>`);
            });
          }
          if (inp.share) {
            const sp = inp.share;
            const shareStr = `${sp.value_percent}% ${(sp.basis||"unknown").replace(/_/g," ")}${sp.year?` (${sp.year})`:""} · ${sp.confidence||"—"} confidence`;
            pills.push(`<span class="quantity-pill share">${esc(shareStr)}<span class="q-label">share</span></span>`);
          }
          return pills.length ? `<div class="quantity-row">${pills.join("")}</div>` : "";
        })()}
        ${renderEvidence(inp.evidence_ids)}
      </div>
    `).join("") || "<p style='color:#94a3b8;font-size:.85rem'>No SRM inputs identified.</p>";

    document.getElementById("detail-content").innerHTML = `
      <div style="margin-top:8px">
        <span class="tier tier-${esc(s.overall_tier)}" style="font-size:0.9rem">${esc(s.overall_tier)}</span>
      </div>
      <div class="detail-company">${esc(c.input_name)}</div>
      <div class="detail-legal">${esc(c.legal_name || "")}
        ${c.org_number ? `· <span class="org">${esc(c.org_number)}</span>` : ""}
      </div>

      <div class="detail-section">
        <h3>Identity</h3>
        <table style="font-size:.83rem;border-collapse:collapse;width:100%">
          ${row2("Homepage", c.homepage_url ? `<a href="${esc(c.homepage_url)}" target="_blank">${esc(c.homepage_url)}</a>` : "—")}
          ${row2("Proff", c.proff_url ? `<a href="${esc(c.proff_url)}" target="_blank">proff.no</a>` : "—")}
          ${row2("NACE", (c.nace_codes||[]).map(n=>`<span class="nace-chip">${esc(n)}</span>`).join(" ") || "—")}
          ${row2("Employees", c.employees?.value != null ? `${c.employees.value.toLocaleString()} (${c.employees.year??""})` : "—")}
          ${row2("Revenue", c.revenue?.value != null ? `${(c.revenue.value/1e6).toFixed(1)} MNOK (${c.revenue.year??""})` : "—")}
        </table>
      </div>

      <div class="detail-section">
        <h3>Overall summary</h3>
        <p class="summary-text">${cite(s.overall_summary || "—", srcMap)}</p>
      </div>

      <div class="detail-section">
        <h3>SRM Inputs (${inputs.length})</h3>
        ${srmCards}
      </div>

      ${s.gaps_and_uncertainties?.length ? `
      <div class="detail-section">
        <h3>Gaps &amp; Uncertainties</h3>
        <ul style="font-size:.83rem;color:#4b5563;padding-left:1.2em;line-height:1.8">
          ${s.gaps_and_uncertainties.map(g => `<li>${cite(g, srcMap)}</li>`).join("")}
        </ul>
      </div>` : ""}

      ${raw.sources?.length ? `
      <div class="detail-section">
        <h3>Sources</h3>
        <div class="source-list">
          ${raw.sources.map(src => {
            const meta = [src.publisher, src.year, src.file_type?.toUpperCase()].filter(Boolean).join(" · ");
            return `<div class="source-item">
              <span class="source-num">${src.source_id}</span>
              <span class="source-type">${esc(src.type.replace(/_/g,"\u00a0"))}</span>
              <div class="source-body">
                <div class="source-title">
                  ${src.url
                    ? `<a href="${esc(src.url)}" target="_blank" rel="noopener">${esc(src.title || src.url)}</a>`
                    : esc(src.title || "—")}
                </div>
                ${meta ? `<div class="source-meta">${esc(meta)}</div>` : ""}
              </div>
            </div>`;
          }).join("")}
        </div>
      </div>` : ""}
    `;

    document.getElementById("detail-panel").classList.add("open");
    document.getElementById("overlay").classList.add("show");
  }

  function row2(label, val) {
    return `<tr>
      <td style="padding:4px 10px 4px 0;color:#64748b;white-space:nowrap;vertical-align:top">${label}</td>
      <td style="padding:4px 0">${val}</td>
    </tr>`;
  }

  function closeDetail() {
    document.getElementById("detail-panel").classList.remove("open");
    document.getElementById("overlay").classList.remove("show");
  }

  document.getElementById("detail-close").addEventListener("click", closeDetail);
  document.getElementById("overlay").addEventListener("click", closeDetail);

  // ---------- Initial render ----------
  renderStats();
  renderTable();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secondary Raw Materials Analysis - EiT 2026 | Norwegian Industry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
            integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g"
            crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-body:     #1f1f1f;
            --bg-main:     #202124;
            --bg-elevated: #292a2d;
            --bg-surface:  #35363a;
            --bg-hover:    #444746;
            --border:      #5f6368;
            --border-soft: #3c3c3c;
            --text-primary:   #e8eaed;
            --text-secondary: #9aa0a6;
            --text-muted:     #5f6368;
            --accent-blue:   #8ab4f8;
            --accent-teal:   #78d9ec;
            --accent-purple: #c58af9;
            --accent-green:  #81c995;
            --accent-amber:  #fdd663;
            --accent-pink:   #f28b82;
            --intensity-nd-bg:  #2a2a2e; --intensity-nd-fg: #4a4a50;
            --intensity-0-bg:   #35363a; --intensity-0-fg: #5f6368;
            --intensity-1-bg:   #0d3b22; --intensity-1-fg: #81c995;
            --intensity-2-bg:   #1a5c35; --intensity-2-fg: #a8d5b5;
            --intensity-3-bg:   #34a853; --intensity-3-fg: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            font-size: 17px;
            background: var(--bg-body);
            padding: 20px;
            color: var(--text-primary);
            line-height: 1.7;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-main);
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        header {
            background: linear-gradient(160deg, #1a1a1a 0%, #202124 60%, #292a2d 100%);
            color: #e8eaed;
            padding: 50px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal));
            border-radius: 2px;
        }

        header h1 {
            font-size: 3.2em;
            margin-bottom: 15px;
            color: #e8eaed;
        }

        header p {
            font-size: 1.5em;
            color: rgba(232,234,237,0.75);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1em;
            color: rgba(232,234,237,0.5);
            margin-top: 10px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: absolute;
            top: 20px;
            right: 30px;
            z-index: 10;
        }

        .nav-link {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.22);
            color: #e8eaed;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.88em;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }

        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.22);
            color: #e8eaed;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.88em;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }

        .section {
            padding: 50px;
        }
        .section.alt {
            background: var(--bg-elevated);
        }
        .section-title {
            font-size: 2.2em;
            color: var(--accent-blue);
            margin-bottom: 15px;
        }
        .section-subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-surface);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-soft);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .stat-card h3 {
            font-size: 2.8em;
            color: var(--accent-teal);
        }
        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .category-section {
            background: var(--bg-surface);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid var(--border-soft);
        }
        .category-title {
            color: var(--accent-teal);
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        .category-description {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 10px;
        }
        .srm-list {
            list-style: none;
            padding-left: 20px;
            color: var(--text-secondary);
        }
        .srm-list li { padding: 5px 0; }
        .srm-list li:before { content: "\2192 "; color: var(--accent-teal); font-weight: bold; }

        /* Matrix */
        .matrix-container { overflow-x: auto; margin-top: 20px; border-radius: 10px; border: 1px solid var(--border-soft); }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.82em; }
        .matrix-table th { background: var(--bg-surface); color: var(--text-secondary); padding: 12px 8px; border-bottom: 2px solid var(--border); text-align: center; font-weight: 600; white-space: nowrap; position: sticky; top: 0; z-index: 2; }
        .matrix-table th.company-name { text-align: left; min-width: 200px; }
        .matrix-table td { padding: 4px 6px; border-bottom: 1px solid var(--border-soft); }
        .matrix-table td.company-cell { white-space: nowrap; padding: 8px 12px; }
        .matrix-cell { text-align: center; padding: 6px 4px; border-radius: 4px; font-size: 0.85em; font-weight: 600; transition: all 0.2s; cursor: default; }
        .matrix-cell:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .intensity-nd { background: var(--intensity-nd-bg); color: var(--intensity-nd-fg); font-style: italic; opacity: 0.6; }
        .intensity-0 { background: var(--intensity-0-bg); color: var(--intensity-0-fg); }
        .intensity-1 { background: var(--intensity-1-bg); color: var(--intensity-1-fg); }
        .intensity-2 { background: var(--intensity-2-bg); color: var(--intensity-2-fg); }
        .intensity-3 { background: var(--intensity-3-bg); color: var(--intensity-3-fg); }
        .matrix-filter-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .matrix-filter-bar input { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 14px; border-radius: 8px; font-size: 0.9em; min-width: 250px; }
        .matrix-filter-bar select { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 14px; border-radius: 8px; font-size: 0.9em; }
        .matrix-filter-bar .count { color: var(--text-muted); font-size: 0.85em; margin-left: auto; }

        /* Company cards */
        .companies-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 20px; }
        .company-card { background: var(--bg-surface); border-radius: 12px; padding: 25px; border: 1px solid var(--border-soft); transition: all 0.3s ease; }
        .company-card:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,0.4); border-color: var(--accent-blue); }
        .company-card h3 { color: var(--accent-blue); font-size: 1.15em; margin-bottom: 10px; }
        .company-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .meta-badge { background: rgba(138,180,248,0.1); border: 1px solid rgba(138,180,248,0.25); color: var(--accent-blue); padding: 3px 10px; border-radius: 15px; font-size: 0.78em; font-weight: 500; }
        .meta-badge.sector { background: rgba(120,217,236,0.1); border-color: rgba(120,217,236,0.25); color: var(--accent-teal); }
        .meta-badge.tier { font-weight: 700; }
        .meta-badge.tier-T3 { background: rgba(52,168,83,0.15); border-color: rgba(52,168,83,0.35); color: var(--accent-green); }
        .meta-badge.tier-T2 { background: rgba(253,214,99,0.15); border-color: rgba(253,214,99,0.35); color: var(--accent-amber); }
        .meta-badge.tier-T1 { background: rgba(197,138,249,0.15); border-color: rgba(197,138,249,0.35); color: var(--accent-purple); }
        .meta-badge.tier-T0 { background: rgba(95,99,104,0.15); border-color: rgba(95,99,104,0.35); color: var(--text-muted); }
        .srm-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .srm-tag { background: rgba(129,201,149,0.1); border: 1px solid rgba(129,201,149,0.25); color: var(--accent-green); padding: 2px 8px; border-radius: 10px; font-size: 0.74em; }
        .company-summary { color: var(--text-secondary); font-size: 0.9em; line-height: 1.6; margin-bottom: 10px; }
        .quantitative-data { background: rgba(253,214,99,0.06); padding: 10px; border-radius: 8px; font-size: 0.85em; color: var(--accent-amber); margin-top: 8px; }
        .sources-link { margin-top: 12px; }
        .sources-link a { color: var(--accent-blue); text-decoration: none; font-size: 0.85em; }
        .sources-link a:hover { text-decoration: underline; }

        /* Charts */
        .chart-container { background: var(--bg-surface); padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid var(--border-soft); }
        .chart-container h3 { color: var(--text-primary); margin-bottom: 15px; }
        .chart-wrapper { height: 400px; }

        /* Company filter */
        .company-filter-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .company-filter-bar input { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 16px; border-radius: 8px; font-size: 0.95em; min-width: 280px; flex: 1; max-width: 400px; }
        .company-filter-bar select { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 14px; border-radius: 8px; font-size: 0.9em; }
        .company-filter-bar .count { color: var(--text-muted); font-size: 0.85em; margin-left: auto; }

        /* Legend */
        .legend { display: flex; gap: 15px; flex-wrap: wrap; margin: 15px 0; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85em; color: var(--text-secondary); }
        .legend-color { width: 40px; height: 25px; border-radius: 4px; }

        footer {
            background: #1a1a1a;
            color: rgba(232,234,237,0.65);
            padding: 30px;
            text-align: center;
            border-top: 1px solid var(--border);
        }
        footer h3 { color: #e8eaed; }

        /* How-to guide */
        .guide-banner {
            background: #fff7ed;
            border-left: 5px solid #ea580c;
            border-bottom: 2px solid #fed7aa;
            margin: 20px 50px 0;
            border-radius: 10px;
            padding: 0;
            overflow: hidden;
        }
        [data-theme="dark"] .guide-banner {
            background: rgba(251,146,60,0.07);
            border-left-color: #fb923c;
            border-bottom-color: rgba(251,146,60,0.15);
        }
        .guide-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            background: none;
            border: none;
            color: #c2410c;
            font-size: 1.15em;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            letter-spacing: 0.01em;
        }
        [data-theme="dark"] .guide-toggle { color: #fb923c; }
        .guide-toggle:hover { background: rgba(234,88,12,0.06); }
        .guide-toggle .arrow { transition: transform 0.2s; }
        .guide-banner.open .guide-toggle .arrow { transform: rotate(180deg); }
        .guide-body {
            display: none;
            padding: 0 24px 24px;
            color: var(--text-secondary);
            font-size: 0.88em;
            line-height: 1.75;
        }
        .guide-banner.open .guide-body { display: block; }
        .guide-body h4 { color: var(--text-primary); font-size: 0.92em; margin: 14px 0 6px; }
        .guide-body h4:first-child { margin-top: 0; }
        .guide-body ul { padding-left: 1.4em; margin: 4px 0; }
        .guide-body .guide-cols { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: 16px; }

        /* Light Mode */
        [data-theme="light"] {
            --bg-body: #f1f5f9; --bg-main: #ffffff; --bg-elevated: #f8fafc;
            --bg-surface: #f1f5f9; --bg-hover: #e2e8f0; --border: #e2e8f0;
            --border-soft: #f1f5f9; --text-primary: #0f172a; --text-secondary: #475569;
            --text-muted: #94a3b8; --accent-blue: #2563eb; --accent-teal: #0891b2;
            --accent-purple: #7c3aed; --accent-green: #059669; --accent-amber: #d97706;
            --accent-pink: #db2777;
            --intensity-nd-bg: #f0f0f2; --intensity-nd-fg: #c0c4cc;
            --intensity-0-bg: #f8fafc; --intensity-0-fg: #94a3b8;
            --intensity-1-bg: #d1fae5; --intensity-1-fg: #065f46;
            --intensity-2-bg: #6ee7b7; --intensity-2-fg: #064e3b;
            --intensity-3-bg: #059669; --intensity-3-fg: #ffffff;
        }
        [data-theme="light"] .container { box-shadow: 0 20px 60px rgba(0,0,0,0.12); }
        [data-theme="light"] header { background: linear-gradient(160deg, #003d7a 0%, #00509e 60%, #1a73c8 100%); }
        [data-theme="light"] header h1 { color: #ffffff; }
        [data-theme="light"] header p { color: rgba(255,255,255,0.85); }
        [data-theme="light"] .subtitle { color: rgba(255,255,255,0.65); }
        [data-theme="light"] footer { background: #00509e; color: rgba(255,255,255,0.8); }
        [data-theme="light"] footer h3 { color: #ffffff; }
        [data-theme="light"] .company-card { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        [data-theme="light"] .company-card:hover { box-shadow: 0 8px 24px rgba(37,99,235,0.12); }
        [data-theme="light"] .stat-card { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        [data-theme="light"] .stat-card:hover { box-shadow: 0 8px 24px rgba(37,99,235,0.1); }
        [data-theme="light"] .meta-badge { background: rgba(37,99,235,0.08); border-color: rgba(37,99,235,0.22); }
        [data-theme="light"] .meta-badge.sector { background: rgba(8,145,178,0.08); border-color: rgba(8,145,178,0.22); color: var(--accent-teal); }
        [data-theme="light"] .srm-tag { background: rgba(5,150,105,0.08); border-color: rgba(5,150,105,0.22); }
        [data-theme="light"] .quantitative-data { background: rgba(217,119,6,0.07); }
        [data-theme="light"] .intensity-3 { box-shadow: 0 0 8px rgba(5,150,105,0.35); }
        [data-theme="light"] .matrix-cell:hover { box-shadow: 0 4px 12px rgba(37,99,235,0.25); }
        [data-theme="light"] .theme-toggle, [data-theme="light"] .nav-link {
            background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.35); color: #ffffff;
        }
        [data-theme="light"] .theme-toggle:hover, [data-theme="light"] .nav-link:hover {
            background: rgba(255,255,255,0.28);
        }
        [data-theme="light"] .matrix-filter-bar input,
        [data-theme="light"] .matrix-filter-bar select,
        [data-theme="light"] .company-filter-bar input,
        [data-theme="light"] .company-filter-bar select {
            background: #fff; border-color: #e2e8f0; color: #0f172a;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-actions">
                <a class="nav-link" href="./viewer.html">Company Viewer</a>
                <a class="nav-link" href="./analytics.html">SRM Analytics</a>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">Dark mode</button>
            </div>
            <h1>Secondary Raw Materials Analysis</h1>
            <p>Mapping the Circular Economy in Norwegian Industry</p>
            <p class="subtitle">EiT 2026 Project - Sirk Norge | NTNU Experts in Teams</p>
            <p class="subtitle" id="generated-date">Research Date: February 25, 2026</p>
        </header>

        <div class="guide-banner" id="guideBanner">
            <button class="guide-toggle" onclick="document.getElementById('guideBanner').classList.toggle('open')">
                <span>How to use this dashboard</span>
                <span class="arrow">&#9660;</span>
            </button>
            <div class="guide-body">
                <div class="guide-cols">
                    <div>
                        <h4>What is this?</h4>
                        <p>This dashboard maps <strong>Secondary Raw Material (SRM)</strong> usage across Norwegian industrial companies. SRMs are recycled or recovered materials and energy sources fed back into production, a key indicator of circular economy activity.</p>
                    </div>
                    <div>
                        <h4>Understanding the tiers</h4>
                        <ul>
                            <li><strong>T3 - Core:</strong> SRM use is a significant part of the company's operations</li>
                            <li><strong>T2 - Meaningful:</strong> Documented, non-trivial SRM usage</li>
                            <li><strong>T1 - Minor:</strong> Pilot projects or small-scale use</li>
                            <li><strong>T0 - No evidence:</strong> Assessed, but no SRM use found</li>
                            <li><strong>N/D - No data:</strong> Not yet assessed</li>
                        </ul>
                    </div>
                    <div>
                        <h4>MECE categories (A1-B3)</h4>
                        <p>The 13 categories cover all material inputs (A1-A10: minerals, metals, plastics, paper, etc.) and energy inputs (B1-B3: solid fuel, biomass, biogas). Each company is scored per category.</p>
                    </div>
                    <div>
                        <h4>How to navigate</h4>
                        <ul>
                            <li>Use the <strong>heatmap matrix</strong> below for a bird's-eye view of all companies vs. categories</li>
                            <li>Use the <strong>search and filters</strong> to narrow down by name or tier</li>
                            <li><strong>Company cards</strong> show detailed profiles with quantitative data and sources</li>
                            <li>Visit <strong>Company Viewer</strong> for a sortable table or <strong>SRM Analytics</strong> for input-level breakdowns</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Executive Summary</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card"><h3>--</h3><p>Companies Analyzed</p></div>
                <div class="stat-card"><h3>--</h3><p>SRM Categories</p></div>
                <div class="stat-card"><h3>--</h3><p>Quantified SRM Inputs</p></div>
                <div class="stat-card"><h3>--</h3><p>NACE Codes Covered</p></div>
            </div>

            <div class="category-section">
                <h3 class="section-subtitle">Key Findings</h3>
                <ul id="keyFindings" style="list-style-position: inside; color: var(--text-secondary);"></ul>
            </div>
        </div>

        <div class="section alt">
            <h2 class="section-title">MECE SRM Categories</h2>
            <p class="section-subtitle">13 categories mapped across material (A1-A10) and energy (B1-B3) inputs</p>
            <div id="categoryList"></div>
        </div>

        <div class="section">
            <h2 class="section-title">Company-to-SRM Matrix</h2>
            <p class="section-subtitle">Tier-based heatmap: T0 (no evidence) to T3 (core/significant use)</p>

            <div class="legend">
                <div class="legend-item"><div class="legend-color intensity-nd"></div><span>N/D - No data collected</span></div>
                <div class="legend-item"><div class="legend-color intensity-0"></div><span>T0 - No evidence</span></div>
                <div class="legend-item"><div class="legend-color intensity-1"></div><span>T1 - Minor/pilot</span></div>
                <div class="legend-item"><div class="legend-color intensity-2"></div><span>T2 - Meaningful</span></div>
                <div class="legend-item"><div class="legend-color intensity-3"></div><span>T3 - Core/significant</span></div>
            </div>

            <div class="matrix-filter-bar">
                <input type="search" id="matrixSearch" placeholder="Search companies...">
                <select id="matrixTierFilter">
                    <option value="">All tiers</option>
                    <option value="data">With data only</option>
                    <option value="T3">T3 only</option>
                    <option value="T2">T2+</option>
                    <option value="T1">T1+</option>
                    <option value="ND">No data only</option>
                </select>
                <span class="count" id="matrixCount"></span>
            </div>

            <div class="matrix-container">
                <table class="matrix-table">
                    <thead id="matrixHead"></thead>
                    <tbody id="matrixBody"></tbody>
                </table>
            </div>
        </div>

        <div class="section alt">
            <h2 class="section-title">Company Profiles</h2>
            <p class="section-subtitle" id="companySubtitle">Detailed SRM usage evidence for Norwegian companies</p>

            <div class="company-filter-bar">
                <input type="search" id="companySearch" placeholder="Search companies, sectors, SRM types...">
                <select id="companyTierFilter">
                    <option value="">All tiers</option>
                    <option value="data">With data only</option>
                    <option value="T3">T3 - Core</option>
                    <option value="T2">T2 - Meaningful</option>
                    <option value="T1">T1 - Minor</option>
                    <option value="T0">T0 - No evidence</option>
                    <option value="ND">N/D - No data collected</option>
                </select>
                <span class="count" id="companyCount"></span>
            </div>

            <div class="companies-grid" id="companiesGrid"></div>
        </div>

        <div class="section">
            <h2 class="section-title">Data Visualizations</h2>
            <div class="chart-container">
                <h3>Companies by Overall SRM Tier</h3>
                <div class="chart-wrapper"><canvas id="tierChart"></canvas></div>
            </div>
            <div class="chart-container">
                <h3>SRM Category Distribution Across Companies</h3>
                <div class="chart-wrapper"><canvas id="srmDistributionChart"></canvas></div>
            </div>
        </div>

        <footer>
            <h3>EiT 2026 Project: Secondary Raw Materials in Norwegian Industry</h3>
            <p style="margin-top: 15px;">Sirk Norge | NTNU Experts in Teams | Data collected February 2026</p>
            <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">Sources: Company sustainability reports, annual reports, EPDs, Proff.no, Bronnøysundregistrene, Norske Utslipp</p>
        </footer>
    </div>

    <script>
        // Security helpers
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = String(str ?? '');
            return div.innerHTML;
        }
        function isSafeUrl(url) {
            try { return ['http:', 'https:'].includes(new URL(url).protocol); }
            catch { return false; }
        }

        const MECE = {
            A1:  { name: 'Mineral & Construction Materials', desc: 'Recycled aggregates, reclaimed asphalt, mineral construction inputs' },
            A2:  { name: 'Industrial Mineral By-Products', desc: 'Slag, fly ash, silica fume, gypsum and similar by-products' },
            A3:  { name: 'Metals Scrap', desc: 'Ferrous and non-ferrous scrap used as metal input' },
            A4:  { name: 'Reprocessed Plastics', desc: 'Recycled polymer pellets, regranulate, PCR/PIR plastics' },
            A5:  { name: 'Glass & Ceramics', desc: 'Cullet and recycled ceramic/refractory material' },
            A6:  { name: 'Paper & Cardboard Fibres', desc: 'Recovered paper and recycled fibre inputs' },
            A7:  { name: 'Textiles & Fibres', desc: 'Recovered textile fibres and recycled yarn/fabric inputs' },
            A8:  { name: 'Rubber & Tyres', desc: 'Crumb rubber, recovered tyre material, devulcanised rubber' },
            A9:  { name: 'Bio-Based Residues (Material)', desc: 'Non-energy organic residues used as material inputs' },
            A10: { name: 'Chemical & Liquid Feedstocks', desc: 'Recovered solvents, oils and chemical feedstock' },
            B1:  { name: 'SRF / RDF', desc: 'Solid recovered fuel / refuse-derived fuel' },
            B2:  { name: 'Biomass Fuels', desc: 'Recovered biomass used as energy input' },
            B3:  { name: 'Biogas', desc: 'Biogas/biomethane used as process or energy input' },
        };
        const MECE_CODES = Object.keys(MECE);
        const TIER_NUM = { T0: 0, T1: 1, T2: 2, T3: 3 };

        (async () => {
            let data;
            try {
                const resp = await fetch('./aggregated.json');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                data = await resp.json();
            } catch (e) {
                document.getElementById('statsGrid').innerHTML =
                    '<p style="color:var(--accent-pink);padding:20px">Failed to load data: ' + escapeHtml(e.message) + '</p>';
                return;
            }

            const companies = (data.companies || []).map(entry => {
                const co = entry.company || {};
                const assess = entry.srm_assessment || {};
                const inputs = assess.srm_inputs || [];

                // Build tier map per MECE category (take max tier per category)
                const catTiers = {};
                const catLabels = {};
                for (const inp of inputs) {
                    const code = inp.mece_category_code || '';
                    const t = TIER_NUM[inp.tier] ?? 0;
                    if (!catTiers[code] || t > catTiers[code]) catTiers[code] = t;
                    if (!catLabels[code]) catLabels[code] = [];
                    catLabels[code].push(inp.label || '');
                }

                const naces = (co.nace_codes || []).map(n => String(n).replace(/\.0+$/, ''));
                const employees = co.employees?.value ?? null;
                const revenue = co.revenue?.value ?? null;

                return {
                    name: co.canonical_name || co.input_name || co.legal_name || 'Unknown',
                    legalName: co.legal_name || '',
                    orgNumber: co.org_number || '',
                    naces,
                    employees,
                    revenue,
                    homepage: co.homepage_url || '',
                    proff: co.proff_url || '',
                    overallTier: assess.overall_tier || 'T0',
                    overallSummary: assess.overall_summary || '',
                    catTiers,
                    catLabels,
                    inputs,
                    hasData: inputs.length > 0,
                    gaps: assess.gaps_and_uncertainties || [],
                    evidence: entry.evidence || [],
                    sources: entry.sources || [],
                };
            });

            // Sort by tier descending, then name
            companies.sort((a, b) => (TIER_NUM[b.overallTier] ?? 0) - (TIER_NUM[a.overallTier] ?? 0) || a.name.localeCompare(b.name));

            // ── Stats ──
            const totalCompanies = companies.length;
            const allNaces = new Set();
            companies.forEach(c => c.naces.forEach(n => allNaces.add(n)));
            const activeCats = new Set();
            companies.forEach(c => { for (const code of Object.keys(c.catTiers)) if (c.catTiers[code] > 0) activeCats.add(code); });
            let quantifiedInputs = 0;
            companies.forEach(c => c.inputs.forEach(inp => {
                if (inp.main_quantity && typeof inp.main_quantity.value === 'number') quantifiedInputs++;
            }));

            document.getElementById('statsGrid').innerHTML = [
                [totalCompanies, 'Companies Analyzed'],
                [activeCats.size, 'Active SRM Categories'],
                [quantifiedInputs, 'Quantified SRM Inputs'],
                [allNaces.size, 'NACE Codes Covered'],
            ].map(([v, l]) => `<div class="stat-card"><h3>${v}</h3><p>${escapeHtml(l)}</p></div>`).join('');

            // ── Key findings (auto-generated) ──
            const tierCounts = { T0: 0, T1: 0, T2: 0, T3: 0 };
            companies.forEach(c => tierCounts[c.overallTier]++);
            const topInputs = {};
            companies.forEach(c => c.inputs.forEach(inp => {
                const code = inp.mece_category_code;
                if (code && (TIER_NUM[inp.tier] ?? 0) >= 2) topInputs[code] = (topInputs[code] || 0) + 1;
            }));
            const sortedCats = Object.entries(topInputs).sort((a, b) => b[1] - a[1]).slice(0, 5);

            const findings = [
                `<strong>${tierCounts.T3} companies</strong> have core/significant SRM usage (T3), <strong>${tierCounts.T2}</strong> have meaningful usage (T2)`,
                `<strong>${totalCompanies} companies</strong> analyzed across <strong>${allNaces.size} NACE codes</strong> in Norwegian industry`,
                ...sortedCats.map(([code, cnt]) => `<strong>${MECE[code]?.name || code}:</strong> ${cnt} companies with meaningful+ usage`),
            ];
            document.getElementById('keyFindings').innerHTML = findings.map(f => `<li>${f}</li>`).join('');

            // ── Category list ──
            const catCompanyCounts = {};
            MECE_CODES.forEach(code => {
                catCompanyCounts[code] = companies.filter(c => (c.catTiers[code] || 0) > 0).length;
            });
            document.getElementById('categoryList').innerHTML = MECE_CODES.map(code => {
                const m = MECE[code];
                const cnt = catCompanyCounts[code];
                const isEnergy = code.startsWith('B');
                return `<div class="category-section">
                    <h3 class="category-title">${escapeHtml(code)}. ${escapeHtml(m.name)} ${isEnergy ? '(Energy)' : '(Material)'}</h3>
                    <p class="category-description">${escapeHtml(m.desc)}</p>
                    <p style="color:var(--accent-green);font-size:0.9em">${cnt} ${cnt === 1 ? 'company' : 'companies'} with evidence of use</p>
                </div>`;
            }).join('');

            // ── Matrix ──
            function renderMatrix() {
                const searchVal = document.getElementById('matrixSearch').value.toLowerCase().trim();
                const tierFilter = document.getElementById('matrixTierFilter').value;

                let filtered = companies;
                if (searchVal) filtered = filtered.filter(c => c.name.toLowerCase().includes(searchVal) || c.legalName.toLowerCase().includes(searchVal));
                if (tierFilter === 'data') filtered = filtered.filter(c => c.hasData);
                else if (tierFilter === 'ND') filtered = filtered.filter(c => !c.hasData);
                else if (tierFilter === 'T3') filtered = filtered.filter(c => c.overallTier === 'T3');
                else if (tierFilter === 'T2') filtered = filtered.filter(c => TIER_NUM[c.overallTier] >= 2);
                else if (tierFilter === 'T1') filtered = filtered.filter(c => TIER_NUM[c.overallTier] >= 1);

                document.getElementById('matrixCount').textContent = `${filtered.length} / ${companies.length} companies`;

                // Only show categories that have at least one non-zero entry in filtered set
                const visibleCats = MECE_CODES.filter(code => filtered.some(c => (c.catTiers[code] || 0) > 0));

                document.getElementById('matrixHead').innerHTML = `<tr>
                    <th class="company-name">Company</th>
                    <th>Tier</th>
                    ${visibleCats.map(code => `<th title="${escapeHtml(MECE[code]?.name || '')}">${escapeHtml(code)}</th>`).join('')}
                </tr>`;

                const tierLabel = { 0: '\u2014', 1: 'T1', 2: 'T2', 3: 'T3' };
                document.getElementById('matrixBody').innerHTML = filtered.map(c => {
                    const cells = visibleCats.map(code => {
                        if (!c.hasData) {
                            return `<td><div class="matrix-cell intensity-nd" title="${escapeHtml(c.name)} - ${escapeHtml(MECE[code]?.name || code)}: No data collected">N/D</div></td>`;
                        }
                        const t = c.catTiers[code] || 0;
                        const labels = (c.catLabels[code] || []).join(', ');
                        return `<td><div class="matrix-cell intensity-${t}" title="${escapeHtml(c.name)} - ${escapeHtml(MECE[code]?.name || code)}: ${tierLabel[t]}${labels ? '\n' + labels : ''}">${tierLabel[t]}</div></td>`;
                    }).join('');
                    const naceStr = c.naces.slice(0, 2).join(', ');
                    const tierClass = c.hasData ? `intensity-${TIER_NUM[c.overallTier] || 0}` : 'intensity-nd';
                    const tierText = c.hasData ? escapeHtml(c.overallTier) : 'N/D';
                    return `<tr>
                        <td class="company-cell"><strong>${escapeHtml(c.name)}</strong><br><small style="color:var(--text-secondary)">${escapeHtml(naceStr)}</small></td>
                        <td><div class="matrix-cell ${tierClass}" style="font-weight:700">${tierText}</div></td>
                        ${cells}
                    </tr>`;
                }).join('');
            }

            document.getElementById('matrixSearch').addEventListener('input', renderMatrix);
            document.getElementById('matrixTierFilter').addEventListener('change', renderMatrix);
            renderMatrix();

            // ── Company Cards ──
            function renderCompanyCards() {
                const searchVal = document.getElementById('companySearch').value.toLowerCase().trim();
                const tierFilter = document.getElementById('companyTierFilter').value;

                let filtered = companies;
                if (searchVal) {
                    filtered = filtered.filter(c =>
                        c.name.toLowerCase().includes(searchVal) ||
                        c.legalName.toLowerCase().includes(searchVal) ||
                        c.overallSummary.toLowerCase().includes(searchVal) ||
                        c.naces.some(n => n.includes(searchVal)) ||
                        Object.keys(c.catTiers).some(code => (MECE[code]?.name || '').toLowerCase().includes(searchVal))
                    );
                }
                if (tierFilter === 'data') filtered = filtered.filter(c => c.hasData);
                else if (tierFilter === 'ND') filtered = filtered.filter(c => !c.hasData);
                else if (tierFilter) filtered = filtered.filter(c => c.overallTier === tierFilter);

                document.getElementById('companyCount').textContent = `${filtered.length} / ${companies.length} companies`;

                const grid = document.getElementById('companiesGrid');
                grid.innerHTML = filtered.map(c => {
                    const usedSRM = Object.entries(c.catTiers)
                        .filter(([, t]) => t > 0)
                        .sort((a, b) => b[1] - a[1])
                        .map(([code]) => MECE[code]?.name || code);

                    const empStr = c.employees ? c.employees.toLocaleString() + ' employees' : '';
                    const naceStr = c.naces.length ? 'NACE ' + c.naces.join(', ') : '';

                    // Get quantitative highlights
                    const quantData = [];
                    for (const inp of c.inputs) {
                        if (inp.main_quantity && typeof inp.main_quantity.value === 'number') {
                            const q = inp.main_quantity;
                            quantData.push(`${inp.label}: ${Number(q.value).toLocaleString()} ${q.unit || ''}${q.period ? ' (' + q.period.replace(/_/g, ' ') + ')' : ''}`);
                        }
                    }

                    const links = [];
                    if (c.homepage && isSafeUrl(c.homepage)) links.push(`<a href="${escapeHtml(c.homepage)}" target="_blank" rel="noopener noreferrer">Website</a>`);
                    if (c.proff && isSafeUrl(c.proff)) links.push(`<a href="${escapeHtml(c.proff)}" target="_blank" rel="noopener noreferrer">Proff.no</a>`);

                    const tierBadge = c.hasData
                        ? `<span class="meta-badge tier tier-${escapeHtml(c.overallTier)}">${escapeHtml(c.overallTier)}</span>`
                        : `<span class="meta-badge tier" style="background:var(--intensity-nd-bg);color:var(--intensity-nd-fg);border-color:var(--intensity-nd-fg);font-style:italic">N/D - No data</span>`;
                    return `<div class="company-card"${!c.hasData ? ' style="opacity:0.65"' : ''}>
                        <h3>${escapeHtml(c.name)}</h3>
                        <div class="company-meta">
                            ${tierBadge}
                            ${empStr ? `<span class="meta-badge">${escapeHtml(empStr)}</span>` : ''}
                            ${naceStr ? `<span class="meta-badge sector">${escapeHtml(naceStr)}</span>` : ''}
                        </div>
                        <div class="srm-tags">
                            ${usedSRM.map(s => `<span class="srm-tag">${escapeHtml(s)}</span>`).join('')}
                        </div>
                        <div class="company-summary">${escapeHtml(c.overallSummary)}</div>
                        ${quantData.length ? `<div class="quantitative-data"><strong>Quantitative Data:</strong><br>${quantData.map(q => escapeHtml(q)).join('<br>')}</div>` : ''}
                        ${links.length ? `<div class="sources-link">${links.join(' | ')}</div>` : ''}
                    </div>`;
                }).join('');
            }

            document.getElementById('companySearch').addEventListener('input', renderCompanyCards);
            document.getElementById('companyTierFilter').addEventListener('change', renderCompanyCards);
            renderCompanyCards();

            // ── Charts ──
            Chart.defaults.color = '#718096';
            Chart.defaults.borderColor = '#2d3748';

            // Tier distribution bar chart
            const ctx1 = document.getElementById('tierChart').getContext('2d');
            const tierChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['T3 - Core', 'T2 - Meaningful', 'T1 - Minor', 'T0 - No evidence'],
                    datasets: [{
                        label: 'Companies',
                        data: [tierCounts.T3, tierCounts.T2, tierCounts.T1, tierCounts.T0],
                        backgroundColor: ['rgba(52,168,83,0.75)', 'rgba(138,180,248,0.75)', 'rgba(197,138,249,0.75)', 'rgba(95,99,104,0.5)'],
                        borderColor: ['#34a853', '#8ab4f8', '#c58af9', '#5f6368'],
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Companies' } } }
                }
            });

            // SRM category distribution
            const catCounts = MECE_CODES.map(code => companies.filter(c => (c.catTiers[code] || 0) > 0).length);
            const catColors = ['#8ab4f8','#78d9ec','#81c995','#fdd663','#c58af9','#f28b82','#f29900','#78d9ec','#a8d5b5','#e8eaed','#ff7043','#66bb6a','#42a5f5'];

            const ctx2 = document.getElementById('srmDistributionChart').getContext('2d');
            const srmDistChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: MECE_CODES.map(code => code + ' ' + (MECE[code]?.name || '').substring(0, 20)),
                    datasets: [{
                        label: 'Companies using category',
                        data: catCounts,
                        backgroundColor: catColors.map(c => c + 'cc'),
                        borderColor: catColors,
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, title: { display: true, text: 'Number of Companies' } } }
                }
            });

            // ── Theme toggle ──
            function updateChartColors(theme) {
                if (theme === 'light') {
                    tierChart.data.datasets[0].backgroundColor = ['rgba(5,150,105,0.75)', 'rgba(37,99,235,0.75)', 'rgba(124,58,237,0.75)', 'rgba(148,163,184,0.5)'];
                    tierChart.data.datasets[0].borderColor = ['#059669', '#2563eb', '#7c3aed', '#94a3b8'];
                    srmDistChart.data.datasets[0].borderColor = ['#2563eb','#0891b2','#059669','#d97706','#7c3aed','#db2777','#0f766e','#0891b2','#059669','#334155','#c2410c','#15803d','#1d4ed8'];
                } else {
                    tierChart.data.datasets[0].backgroundColor = ['rgba(52,168,83,0.75)', 'rgba(138,180,248,0.75)', 'rgba(197,138,249,0.75)', 'rgba(95,99,104,0.5)'];
                    tierChart.data.datasets[0].borderColor = ['#34a853', '#8ab4f8', '#c58af9', '#5f6368'];
                    srmDistChart.data.datasets[0].borderColor = catColors;
                }
                tierChart.update();
                srmDistChart.update();
            }

            function updateToggleLabel(theme) {
                document.getElementById('themeToggle').textContent = theme === 'dark' ? 'Light mode' : 'Dark mode';
            }

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateToggleLabel(savedTheme);
            if (savedTheme !== 'dark') updateChartColors(savedTheme);

            document.getElementById('themeToggle').addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                updateToggleLabel(next);
                updateChartColors(next);
            });

            // Update generated date
            if (data.generated_at) {
                document.getElementById('generated-date').textContent = 'Data generated: ' + new Date(data.generated_at).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
            }
        })();
    </script>
</body>
</html>